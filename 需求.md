````markdown
# 微信小程序「积分兑换系统」需求说明（可直接交给 Claude Code 实现）

> 目标：用**最低成本/最低配置**实现一个可用的积分系统  
> - 后端：Python + SQLite（单机即可）  
> - 小程序端：积分查询、兑换商品、兑换记录  
> - Web 管理端：会员列表、积分增减、明细查看、商品管理、兑换订单管理  
> - 会员唯一标识：**OpenID（微信登录获取）**

---

## 1. 角色与权限

### 1.1 角色
1) **普通用户（小程序）**
- 使用微信登录获取 OpenID
- 查询积分余额、积分明细
- 浏览可兑换商品
- 发起兑换（扣积分、生成兑换订单）
- 查看兑换记录/订单状态

2) **管理员（Web 管理端）**
- 登录后台（用户名+密码，或简单 Token）
- 查看会员列表（按 OpenID 聚合）
- 给会员**加/减积分**（强制走“积分流水”）
- 查看会员积分明细（流水）
- 管理商品（上/下架、库存、所需积分）
- 管理兑换订单（发货/核销/取消）

### 1.2 权限边界
- 小程序端只能访问自己的数据（依据 OpenID）
- 管理端可访问全部会员/订单
- 管理端“加减积分”必须记录操作者、原因、关联业务单号（可选）

---

## 2. 核心业务规则（必须实现）

### 2.1 积分模型
- 积分采用**账户余额 + 流水账**模式  
- 余额可由流水汇总得到，但为性能可存 `points_balance`，每次变更必须事务一致更新

### 2.2 积分变更来源
1) 管理端手工加分（例如活动赠送）
2) 管理端手工扣分（纠错/惩罚）
3) 用户兑换扣分（系统自动）

### 2.3 兑换规则
- 商品有：`所需积分 points_cost`、`库存 stock`、`状态 enabled`
- 兑换时必须满足：
  - 用户积分余额 `>= points_cost`
  - 商品 `enabled = true`
  - `stock > 0`（如商品不设库存，可用 `stock = -1` 表示无限；默认用有限库存更安全）
- 兑换过程必须是**原子事务**：
  1) 校验余额与库存
  2) 扣减库存
  3) 扣减用户积分（写入流水）
  4) 生成兑换订单
- 防并发超卖：在 SQLite 下用事务 + 行级逻辑控制（简化：同一时刻串行写也可接受）

### 2.4 订单状态机（最小可用）
- `PENDING`：已兑换待处理
- `FULFILLED`：已完成（已发货/已核销）
- `CANCELLED`：已取消（取消是否退积分：**默认不退**；如要退，必须走一笔“退还流水”）

---

## 3. 技术实现约束（明确给 AI）

### 3.1 后端推荐技术栈（可替换但需同等能力）
- Python 3.11+
- FastAPI（或 Flask，但 FastAPI 更适合接口文档）
- SQLite（单文件数据库）
- SQLAlchemy（可选）/ 直接 `sqlite3`（也可）
- JWT 或自定义 Session：用于管理端认证
- 微信登录：使用 `wx.login` 获取 code，后端调用 `jscode2session` 换取 OpenID

### 3.2 微信侧配置
- 需要微信小程序：`appid`、`appsecret`
- 后端需要配置项：
  - `WECHAT_APPID`
  - `WECHAT_SECRET`
  - `ADMIN_USERNAME`
  - `ADMIN_PASSWORD`（或 `ADMIN_TOKEN`）
  - `DB_PATH=./data.db`

### 3.3 运行形态
- 单机部署即可：`uvicorn main:app --host 0.0.0.0 --port 8000`
- 静态 Web 管理端可用简单前端（Vue/React）或后端模板都可以  
  **最低成本方案：后端提供 REST API + 一个简单的 HTML 管理页面（可选）**
- 必须启用 CORS（仅允许管理端域名/本地开发）

---

## 4. 数据库设计（SQLite）

> 所有表必须包含 `id`（主键自增或 UUID）、`created_at`、`updated_at`

### 4.1 users（会员表）
- `id` INTEGER PK
- `openid` TEXT UNIQUE NOT NULL
- `nickname` TEXT NULL（可后续接入）
- `avatar_url` TEXT NULL
- `points_balance` INTEGER NOT NULL DEFAULT 0
- `status` TEXT NOT NULL DEFAULT 'ACTIVE'  （ACTIVE/BLOCKED）

索引：
- UNIQUE(openid)

### 4.2 points_ledger（积分流水表）
- `id` INTEGER PK
- `openid` TEXT NOT NULL
- `delta` INTEGER NOT NULL  （正数加分，负数扣分）
- `balance_after` INTEGER NOT NULL
- `type` TEXT NOT NULL  
  - ADMIN_ADJUST
  - REDEEM
  - REFUND（可选）
- `reason` TEXT NOT NULL（管理员填写/系统写固定文案）
- `ref_id` TEXT NULL（关联订单号/外部业务号，可选）
- `operator` TEXT NULL（管理员账号；系统写 'SYSTEM'）

索引：
- INDEX(openid, created_at)

### 4.3 products（兑换商品表）
- `id` INTEGER PK
- `name` TEXT NOT NULL
- `desc` TEXT NULL
- `image_url` TEXT NULL
- `points_cost` INTEGER NOT NULL
- `stock` INTEGER NOT NULL  （>=0；或 -1 表示无限库存）
- `enabled` INTEGER NOT NULL DEFAULT 1（0/1）
- `sort` INTEGER NOT NULL DEFAULT 0

索引：
- INDEX(enabled, sort)

### 4.4 redeem_orders（兑换订单表）
- `id` INTEGER PK
- `order_no` TEXT UNIQUE NOT NULL（例如时间戳+随机）
- `openid` TEXT NOT NULL
- `product_id` INTEGER NOT NULL
- `product_name_snapshot` TEXT NOT NULL
- `points_cost_snapshot` INTEGER NOT NULL
- `status` TEXT NOT NULL DEFAULT 'PENDING'
- `remark` TEXT NULL（管理员备注）
- `fulfill_info` TEXT NULL（发货单号/核销信息）

索引：
- UNIQUE(order_no)
- INDEX(openid, created_at)
- INDEX(status, created_at)

---

## 5. 接口设计（REST API）

> 统一返回结构（建议）：
```json
{ "code": 0, "msg": "ok", "data": {...} }
````

### 5.1 小程序端接口

#### 5.1.1 微信登录换取 OpenID

* `POST /api/wx/login`
* Body: `{ "code": "wx.login返回的code" }`
* 返回：

  * `openid`
  * `session_token`（建议后端签发一个 JWT/自定义 token，后续请求带上）
* 说明：

  * 后端调用微信 `jscode2session`，拿到 `openid`（和 `session_key`）
  * 首次登录自动创建 users 记录

#### 5.1.2 获取我的积分信息

* `GET /api/me`
* Header: `Authorization: Bearer <session_token>`
* 返回：`openid`, `points_balance`

#### 5.1.3 获取我的积分明细（分页）

* `GET /api/me/points-ledger?page=1&page_size=20`
* 返回：列表（delta、type、reason、created_at、balance_after）

#### 5.1.4 商品列表

* `GET /api/products`
* Query: `enabled=1`
* 返回：商品列表（name、desc、image_url、points_cost、stock）

#### 5.1.5 商品详情

* `GET /api/products/{id}`

#### 5.1.6 发起兑换

* `POST /api/redeem`
* Body: `{ "product_id": 123 }`
* 返回：`order_no`, `status`, `points_balance_after`
* 事务要求：扣库存 + 扣积分 + 写流水 + 写订单 必须一致

#### 5.1.7 我的兑换订单（分页）

* `GET /api/me/orders?page=1&page_size=20`
* 返回：订单列表

---

### 5.2 管理端接口

#### 5.2.1 管理员登录

* `POST /admin/login`
* Body: `{ "username": "...", "password": "..." }`
* 返回：`admin_token`

#### 5.2.2 会员列表（分页/搜索）

* `GET /admin/users?page=1&page_size=20&openid=xxx`
* 返回：openid、points_balance、created_at

#### 5.2.3 查看会员积分明细

* `GET /admin/users/{openid}/points-ledger?page=1&page_size=50`

#### 5.2.4 管理员加/减积分

* `POST /admin/users/{openid}/points-adjust`
* Body:

```json
{
  "delta": 100,
  "reason": "活动赠送",
  "ref_id": "optional"
}
```

* 规则：

  * `delta` 可正可负，但扣分不得导致余额小于 0（默认不允许）
  * 必须写入 points_ledger，并更新 users.points_balance（同一事务）

#### 5.2.5 商品管理

* `POST /admin/products` 创建
* `PUT /admin/products/{id}` 更新（name/desc/image_url/points_cost/stock/enabled/sort）
* `GET /admin/products` 列表（含 disabled）
* `DELETE /admin/products/{id}`（可选；更推荐软删除：enabled=0）

#### 5.2.6 订单管理

* `GET /admin/orders?page=1&page_size=20&status=PENDING`
* `PUT /admin/orders/{order_no}/fulfill`

  * Body: `{ "fulfill_info": "快递单号xxx", "remark": "..." }`
  * 将状态置为 `FULFILLED`
* `PUT /admin/orders/{order_no}/cancel`

  * Body: `{ "remark": "..." , "refund": false }`
  * 默认不退积分；若 `refund=true`，则必须：

    * 加回库存（可选）
    * 走一笔积分流水 REFUND（delta 为正）
    * 更新余额
    * 订单状态置 CANCELLED

---

## 6. 小程序页面与交互（最小闭环）

### 6.1 页面列表

1. 首页 / 个人中心

* 显示：积分余额、入口（积分明细、兑换商城、我的订单）

2. 兑换商城（商品列表）

* 展示商品、所需积分、库存
* 点击进入详情

3. 商品详情

* 展示详情
* 按钮「立即兑换」
* 兑换成功弹窗：订单号/状态

4. 我的订单

* 列表：商品名、积分、状态、时间
* 详情：订单号、状态、管理员填写的 fulfill_info（如果有）

5. 积分明细

* 列表：+100 / -50、原因、时间、余额

### 6.2 登录与会话

* 小程序启动时调用 `wx.login` -> `/api/wx/login` 获取 `session_token`
* token 存储到 `wx.setStorageSync`
* 后续所有请求带 `Authorization: Bearer <token>`
* token 过期则重新 login

---

## 7. Web 管理端页面（最低可用）

> 允许两种实现方式：

1. 纯后端渲染（HTML 模板）+ 少量 JS
2. 简单 SPA（Vue/React）调用 REST API

### 7.1 页面

1. 登录页
2. 会员列表页

* 搜索 openid
* 显示余额
* 点击进入会员详情

3. 会员详情页

* 显示 openid、余额
* 表单：加/减积分（delta、reason）
* 表格：积分流水

4. 商品管理页

* 商品列表、创建、编辑、上/下架、库存调整

5. 订单管理页

* 筛选 PENDING
* 填写 fulfill_info 完成订单
* 可取消订单（可选退款开关）

---

## 8. 非功能性要求（必须写清）

### 8.1 数据一致性与事务

* 任何积分余额变化必须：

  * 写入 points_ledger
  * 更新 users.points_balance
  * 同一事务提交
* 兑换必须保证扣库存/扣积分/写订单一致

### 8.2 安全

* 管理端必须有鉴权（admin_token）
* 小程序端 token 校验，禁止访问他人数据
* 接口防注入：参数校验
* 日志：记录管理端操作（至少记录 operator、openid、delta、reason）

### 8.3 可观测性

* 简单日志输出：请求、错误、关键业务（兑换/加减分）
* 提供 `/health` 接口返回 ok

---

## 9. 初始化数据与脚本（交付物要求）

### 9.1 必须提供的交付物

* 后端完整工程（可运行）
* SQLite 初始化脚本（建表）
* 示例配置 `.env.example`
* README：启动方式、微信配置、接口说明
* （可选）一个最简管理端页面

### 9.2 初始管理员

* 通过环境变量配置
* 首次启动即可登录

### 9.3 示例商品

* 提供一个 seed 脚本：插入 3 个商品（不同积分、库存）

---

## 10. 验收用例（必须能跑通）

1. 小程序首次登录 -> 生成 users 记录（openid 唯一）
2. 管理端给该 openid 加 200 分 -> 余额变 200，流水记录正确
3. 小程序查询余额=200
4. 管理端创建一个商品：100 分，库存 10，上架
5. 小程序兑换该商品一次 -> 余额变 100，订单生成 PENDING，库存变 9，流水 REDEEM 记录正确
6. 管理端将订单标记 FULFILLED -> 小程序订单状态更新可见
7. 扣分不允许余额为负（默认规则）
8. 并发测试（简化）：连续快速点击兑换不应出现负库存或负余额

---

## 11. 项目结构建议（给 AI 的实现指令）

后端建议结构：

* `app/main.py`（FastAPI 启动入口）
* `app/config.py`（环境变量）
* `app/db.py`（SQLite 连接/会话/迁移）
* `app/models.py`（表结构）
* `app/services/points.py`（积分服务：adjust/redeem/ledger）
* `app/services/wechat.py`（jscode2session）
* `app/routers/api.py`（小程序接口）
* `app/routers/admin.py`（管理端接口）
* `app/auth.py`（token 校验）
* `scripts/init_db.py`（初始化建表）
* `scripts/seed.py`（种子数据）

---

## 12. 明确不做（避免 AI 过度扩展）

* 不做复杂会员资料（只用 openid）
* 不做微信支付、真实订单支付
* 不做复杂权限系统（仅管理员/用户）
* 不做多商户、多门店、多管理员角色分级（先单管理员）
* 不做消息订阅通知（后续可加）

---

## 13. 可选增强（如实现简单可加分）

* 商品支持“无限库存”（stock=-1）
* 订单取消可选择是否退款
* 管理端导出 CSV（会员/流水/订单）
* Swagger/OpenAPI 文档自动生成（FastAPI 默认支持）

```
```
